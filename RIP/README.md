# L3 - Сетевой уровень

протоколы сетевого уровня исполняются не только на хостах но и на маршрутизаторах

форвардинг или перенаправление - передача роутером полученной на вход дейтаграммы на нужный выход
маршрутизация или роутинг - опеределение путей по которым пакеты будут доходить от отправителей к получателям

форвардинг делает конкретный роутер для конкретного поступившего ему пакета

роутинг выполняется коллективно и позволяет маршрутизаторам строить таблицы маршрутизации на основе которых делает форвардинг

форвардинг - проезд через перекреток который придедет вас быстрее к цели
роутинг - планирование поездки по заранее удобному пути

сетевой уровень делится на два подуровня:
- передающий (data plane)
- управляющий (control plane)

передающий - IP - он отвечает за адресацию и перенаправление

управляющий - RIP, OSFP, BGP - строят топологию сети и ищцт оптимальные маршруты

## Таблица маршрутизации

получая пакет роутер сверяет IP адрес получателя с таблицей на основе чего решает на какой выход его передать
таблица используется на передающем подуровне для форвардинга а на управляющем происходит ее расчет.

децентрализованный роутинг - запуск алгоритма маршрутизации на каждом роутере, который затем общается с другими

***

сетевой слой гаранитрует только "приложить все усилия" для доставки (best-effort-service), не гарантирует доставку

• Gateway в таблице – IP-адрес следующего узла

• Обычно есть ещё адрес или номер интерфейса-выхода, по которому доступен следующий узел, а также значение приоритета

## устроство маршрутизатора (роутера)

у роутера есть несколько сетевых интерфейсов:
- входные порты
- выходные порты (не путать с портами транспортного уровня)

от входного до нужного выходного порта пакет дойдет через аппаратно реализованную коммутирующую матрицу

аппаратная реализация - схема из логич элементов на плате
программная - исполнение инструкций процессором

## Как решить какие пакеты на какой выход перенаправлять?

решение на основе IP адреса получателя указанного в заголовках дейтаграммы

В таблице маршрутизации можно было бы для
каждого возможного IP-адреса указать
соответствующий выход...
• ...но для IPv4 потребовалось бы более 4
миллиардов записей, а для IPv6 –
340282366920938463463374607431768211456
(2^128)

поэтому в таблице выходам сопоставляются префиксы или маски адресов
если адрес совпадает с несколькими префиксами то выбирается самый длинный

• Здесь пример ближе к тому, как мы можем
«видеть» (и вручную задавать) таблицу
• Префикс получается побитовым перемножением
указанного в таблице адреса (Network destination)
и маски подсети (Netmask)
• Они обычно записываются в десятичном, а не в
двоичном представлении
• Примеры из таблицы:
• 127.0.0.0 и 255.0.0.0 -> 127.xxx.xxx.xxx
192.168.0.0 и 255.255.255.0 -> 192.168.0.xxx
192.168.0.100 и 255.255.255.255 -> 192.168.0.100

реализуется передача через шину которая не требует участия процессора но можно передавать только один пакет за раз, а так же пакет по шине приходт на все выходы  и каждый выход должне проверять ему ли этот пакет предназначен,
поэтмоу чтобы преодолеть ограничение на передачу одного пакета роутеры используют внутреннюю сеть шин, которые соединяют все выходы со всеми выходами,
но при этом пересекаются образуюя систему координат
### планирование пакетов

в саммо простом случае - FIFO,  в том порядке в каком были получены
или очереди с приоритетами который можно настраивать

еще круговые очереди и взвешенные очереди - round-robin(поочередно берется пакет из очереди одного класса зачем следующий и так по кругу, его реализуют DNS)
Вес очереди определяет сколько времени она может получить отностительно других очередей

## Структура дейтаграммы IPv4:
Version - версия протокола IP
Header length - длина заголвках как колво 32 битных строк(практически всегда 20 байт)
Type of service - несет тип/приоритет траффика и в расширенном стандарте информацию о перегрузке
Datagram length - полный размер датаграммы в байтах
Identifier, Flags, Fragmentation offset - поля для фрагментации на уровне IP
TTL - колько переходов после которого пакет будет отброшен
Upper-layer Protocol - код протокола уровнем выше
Header checksum - контрольная сумма заголовка
Source Ip address - айпи отправителя изначального
destination Ip address - айпи получателя
Options - различные доп параметры в переменно колве(не используется)
Data - наши инкапс данные с транспортного и прикладного слове

# Адресация IPv4

ip устройства должен быть уникальным если не используется NAT

состоит из 4 байт
всего 2^32 - 4 миллиарда адресов уникальных 

глобальная сеть разделяется на подсети
адреса в одной подсети имеют одинаковый префикс и записываются с помощью маски
нужно для роутинга

если бы адреса интерфейсов были бы случайными то в таблице нужно было хранить запись на каждый адрес

подсеть необяз содержит хосты

## иерархия адресов
84.0.0.0/8 0 выдан RIPE NCC для распределения
84.237.0.0/17 - выдан ИВТ СО РАН от выше
84.237.48.0/21 - выдн НСУНЕТ(кому) от выше
84.237.54.27 - выдн мне в общагу нсунетом

127.0.0.0/8 - localhost
10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 - приавтные или серые адреса маршрутизация по которым только локально
255.255.255.255 - локальный broadcast-адрес 


Для назначения каждом интерфейсу адреса отвечает DHCP (Dynamic Host Configuration Protocol)

Разделение адресного пространства на блоки происходит по бесклассовому принципу CIDR(Classless InterDomain Routing)

Так как  адреса выдатся блкоами то провайдер должен передавать пользователям блоки, при этом страдает IPv4 страдает нехваткой адресов и при припятсвие анонимности
используется NAT(Network Address Translation) - роутер меняет адреса во всех входящих и исходящих пакетах в соотвествии с таблицей трансляции

 • Как роутер понимает, кому передать входящий пакет,  
если внешний адрес у всех устройств в подсети один? 
• Для этого роутер должен «залезть» на транспортный  
уровень и подменить порт, записав его затем в свою  
таблицу трансляции 
• На каждую пару локальный адрес/порт роутер  
выделит свой собственный порт 
• Для устройств «снаружи» вся наша локальная сеть  
будет выглядеть как одно устройство – наш роутер 
• Конечно, роутер не хранит записи для всех возможны  
пар локальный адрес/порт – только для тех, где  
локальный хост инициировал обмен пакетами 
• Через некоторое время запись удаляется 

# IPv6
128 бит или 16 байт
2^128 адрсесов

записывается как 8 2х битных числа(шетснадцатеричных) через двоеточие

ICMP: контрольные сообщения 
• Напоследок кратко рассмотрим «вспомогательный» к IP протокол – ICMP (Internet Control  Message Protocol) [RFC 792] 
• Его данные оборачиваются в дейтаграммы IP, как сегменты TCP или UDP 
• ICMP сигнализирует об ошибках IP, а также позволяет проверить доступность устройства 
• Поля ICMP содержат тип и код события, а также информацию об IP-дейтаграмме, которая  вызвала событие 
• Например, если роутер не знает, куда перенаправить пакет с указанным адресом, он отправит  обратно ICMP-пакет с типом 3 и кодом 0 («Сеть назначения недостижима») 
• Выполняя в консоли команду ping мы отправляем ICMP-пакет с типом 8 и кодом 0 («Эхо  запрос»), а обратно ожидаем получить ICMP-пакет с типом 0 и кодом 0 («Эхо ответ») 
• Другая утилита, использующая ICMP – traceroute (tracert в Windows), которая позволяет увидеть  все устройства на пути от нашего хоста до любого другого хоста по глобальному адресу 

# Routing Informatiom Protocol

стоимость пути считается просто по количеству рёбер на нём (hop count кол-во прыжков)

каждые 30 сек роутер отправляет запрос на каждый свой интерфейс
соседние роутеры получив запрос передают ему свои таблицы маршрутизации
роутер обновляет свою таблицу добавляя новые достижимые IP адреса и обновляя старые записи если был обнаружен более оптимальный путь
если стоимость равна то сохраняет несоклько путей

изначальное есть только записи о соседних устройствах 

полсе получения ответа rip запроса роутер будет знать о соседях через одного
через несколько итераций каждый маршрутизатор будет иметь записи в таблице по которым сможет перенаправить пакет до любого доступного получателя

хосты не могут использовать RIP если они подключены к несколкьим маршрутизаторам

LS(Link state) алгоритмы считают пути на основе полной информации о сети(графе связей)
Distance-vector(DV) алгоримам достаточно информации о непосредственных соседях узла и предрассчитанных стоимостей от них до остальных узлов
используется в RIP

RIP ограничен 15 прыжами ид олгой сходимостью

Уровень - прикладной(тк работает поверх UDP), но фактически - сетевой, тк занимается маршрутизацией
относится к дистанционно-векторным протоколам


## Немного о OSFP

Open Shortest Path Fisrt

протокол с LS алгоритмом

расчет путей по Дейкстру

веса ребер могут быть настроены администратором на каждом роутере

роутер посылает сообщения не только соседям но и всем роутерам лавинообразоно - соседи должны переслать сообщение своим соседям итд

каждый роутер хранит всю информацию о сети в LSDB
сообщения протокола передают LSA(LS advertisement) - уведомления об изменении состояния связей

При первом подключении, а затем каждые 10 секунд каждый роутер отправляет HELLO -пакет, и ожидает получить его обратно от соседей

## Автономные системы

группы роутров под общим админитративным управлением с единой политикой маршрутизации

работает только один внутренний протокол маршрутизации - RIP или OSPF
Для маршрутизации между АС нужны внешние протоколы

### BGP

Bortder Gateway Protocol
единый протокол роутинга между АС

Если IP обеспечивает глобальную адресацию, то BGP связывает между собой автономные системы в одну единую сеть – поэтому он не менее важен для функционирования сети

позволяет АС передавать инфу о себе остальным АС в сети
передает префиксты в соответствии с CIDR

таблица bgp включает только пути до префиксов

Роутеры в АС делятся на внутренние и пограничные, только пограничные могут быть связаны с роутерами другой АС

• Передача этой информации происходит между роутерами по транспортному протоколу TCP
• Внутри одной АС каждый роутер имеет TCP-соединение с каждым (internal BGP, iBGP), снаружи
обычно есть одно физическое соединение между двумя роутерами разных АС (external BGP, eBGP)
• Получив сообщение из другой АС (роутер 2c в AS2 на илл.), пограничный роутер пересылает его
всем внутренним, они запоминают новую информацию о префиксе
• Пограничный роутер, получив сообщение изнутри (2a в AS2) перешлет его в соседнюю АС

• У путей в BGP есть два важных атрибута:
• AS-PATH – список АС в пути до префикса
• NEXT-HOP – IP-адрес первого роутера в другой АС из пути
• Например, для пути из AS1 до префикса X NEXT-HOP будет содержать адрес роутера 2a из AS2,
а AS-PATH будет просто списком «AS2 AS3»
• Если АС получает снаружи BGP-пакет, в AS-PATH которого уже есть она сама, такой путь будет
отброшен, чтобы не допустить образование петли

• На каждом роутере BGP собирает доступные пути до
АС в своей таблице, но это не таблица
маршрутизации роутера!
• Чтобы добавить туда запись с префиксом, BGP
выбирает путь по следующим правилам:
• Сначала учитываются локальные политики
предпочтения, заданные администратором сети
• Затем выбирается путь с самым коротким AS
-PATH
• Если таких несколько, то выбирается один с самым
оптимальным путем до NEXT

-HOP, вычисленным внутренним протоколом маршрутизации (RIP, OSPF)
• Это так называемый принцип горячей картошки
– как
можно быстрее передать пакет за пределы нашей АС
• После этого добавляется запись в таблицу
маршрутизации
